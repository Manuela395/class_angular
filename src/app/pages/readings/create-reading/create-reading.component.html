<div class="page-container">
  <section class="hero">
    <div class="hero-content">
      <h1>CREAR LECTURA ECG</h1>
      <p>Registra lecturas de electrocardiograma a partir de sesiones activas.</p>
    </div>
    <div class="hero-status" [class.connected]="deviceConnected">
      <span>{{ deviceConnected ? 'Dispositivo conectado' : 'Dispositivo desconectado' }}</span>
    </div>
  </section>

  <form [formGroup]="lecturaForm" (ngSubmit)="createLectura()" class="reading-form">
    <section class="card session-card">
      <header class="card-header">
        <div>
          <h2>Datos de la sesi√≥n</h2>
          <p>Selecciona un paciente con sesi√≥n disponible y verifica la informaci√≥n cl√≠nica asociada.</p>
        </div>
        <div class="pill-group">
          <span class="pill">
            Registros: {{ lecturaForm.value.recordCount || 0 }}
          </span>
          <span class="pill" *ngIf="currentBPM > 0">
            BPM actual: {{ currentBPM }}
          </span>
        </div>
      </header>

      <div class="field-row">
        <div class="field">
          <label for="patientId">Nombre del paciente *</label>
          <select
            #patientSelect
            id="patientId"
            formControlName="patientId"
            (change)="onPatientSelected(patientSelect.value)">
            <option value="">Seleccione un paciente</option>
            <option *ngFor="let patient of patients" [value]="patient.patient_id">
              {{ patient.patient_name }} {{ patient.patient_last_name }}
            </option>
          </select>
          <small *ngIf="lecturaForm.get('patientId')?.touched && lecturaForm.get('patientId')?.invalid">
            El paciente es requerido
          </small>
        </div>
        <div class="field">
          <label>Identificaci√≥n del paciente</label>
          <input type="text" [value]="selectedPatient?.patient_identification || ''" readonly>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label>Doctor responsable</label>
          <input type="text" [value]="doctorDisplay" placeholder="Selecciona un paciente" readonly>
        </div>
        <div class="field">
          <label>Dispositivo asignado</label>
          <input type="text" [value]="deviceDisplay" placeholder="Sin asignar" readonly>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="recordCount">N√∫mero de registros *</label>
          <input
            type="number"
            id="recordCount"
            formControlName="recordCount"
            min="1"
            placeholder="Ej. 2">
          <small *ngIf="lecturaForm.get('recordCount')?.touched && lecturaForm.get('recordCount')?.invalid">
            <span *ngIf="lecturaForm.get('recordCount')?.errors?.['required']">Indica cu√°ntas capturas se generar√°n.</span>
            <span *ngIf="lecturaForm.get('recordCount')?.errors?.['min']">Debe ser al menos 1.</span>
          </small>
        </div>
        <div class="field">
          <label>Estado de conexi√≥n</label>
          <div class="status-chip" [class.connected]="deviceConnected">
            <span class="dot"></span>
            {{ deviceConnected ? 'Conectado' : 'Desconectado' }}
          </div>
        </div>
      </div>
    </section>

    <section class="card monitor-card">
      <header class="card-header">
        <div>
          <h2>Monitor en vivo</h2>
          <p>Visualiza la se√±al ECG y controla la grabaci√≥n de la sesi√≥n.</p>
        </div>
        <div class="actions">
          <button
            type="button"
            class="ghost-btn"
            (click)="connectDevice()"
            [disabled]="deviceConnected">
            Conectar
          </button>
          <button
            type="button"
            class="ghost-btn danger"
            (click)="disconnectDevice()"
            [disabled]="!deviceConnected">
            Desconectar
          </button>
        </div>
      </header>

      <div class="monitor-wrapper">
        <div class="monitor-placeholder" *ngIf="!deviceConnected">
          <div class="icon">üì°</div>
          <p>Conecta el dispositivo ECG para iniciar la transmisi√≥n en vivo.</p>
        </div>

        <div class="monitor-live" *ngIf="deviceConnected">
          <app-ecg-monitor-embedded
            [deviceId]="'esp32-ecg-01'"
            (dataReceived)="onEcgDataReceived($event)">
          </app-ecg-monitor-embedded>

          <div class="recording-info">
            <span *ngIf="!isRecording" class="state waiting">
              Esperando inicio de grabaci√≥n
            </span>
            <span *ngIf="isRecording" class="state recording">
              ‚óè Grabando ¬∑ {{ formatTime(recordingTime) }}
            </span>
          </div>

          <div class="progress" *ngIf="isRecording">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="recordingProgress"></div>
            </div>
            <span class="progress-label">
              {{ recordingProgress.toFixed(0) }}% ¬∑ {{ formatTime(recordingTime) }} / 01:00
            </span>
          </div>
        </div>
      </div>

      <div class="monitor-actions">
        <button
          type="button"
          class="primary-btn"
          (click)="startRecording()"
          [disabled]="!deviceConnected || isRecording">
          Iniciar grabaci√≥n (60s)
        </button>
        <button
          type="button"
          class="secondary-btn"
          (click)="stopRecording()"
          [disabled]="!isRecording">
          Detener
        </button>
      </div>
    </section>

    <section class="card description-card">
      <header class="card-header">
        <div>
          <h2>Descripci√≥n cl√≠nica</h2>
          <p>Resume la observaci√≥n del especialista para esta lectura.</p>
        </div>
      </header>
      <textarea
        id="observations"
        rows="4"
        formControlName="observations"
        placeholder="La se√±al de ECG es normal, no se detectan tramos anormales entre intervalos.">
      </textarea>
    </section>

    <footer class="form-actions">
      <button type="button" class="ghost-btn" (click)="cancel()">Cancelar</button>
      <button
        type="submit"
        class="primary-btn"
        [disabled]="lecturaForm.invalid || !deviceConnected || recordingTime === 0">
        Guardar lectura
      </button>
    </footer>
  </form>
</div>